name: Build and publish wheels

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to PyPI'
        type: boolean
        default: false

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-14
            llvm_install: brew install llvm
            llvm_include: /opt/homebrew/opt/llvm/include
            llvm_lib: /opt/homebrew/opt/llvm/lib
          - os: ubuntu-latest
            llvm_install: sudo apt-get update && sudo apt-get install -y llvm-18-dev liblldb-18-dev
            llvm_include: /usr/lib/llvm-18/include
            llvm_lib: /usr/lib/llvm-18/lib
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"

      - name: Detect Mojo version
        run: |
          MOJO_VERSION=$(gh api repos/modular/mojo/releases/latest --jq .tag_name | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "MOJO_VERSION=$MOJO_VERSION" >> $GITHUB_ENV
          echo "Mojo version: $MOJO_VERSION"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Install LLVM
        run: |
          ${{ matrix.llvm_install }}
          echo "--- Verify headers ---"
          ls ${{ matrix.llvm_include }}/lldb/Target/Target.h
          ls ${{ matrix.llvm_include }}/lldb/API/SBDebugger.h

      - name: Build server
        run: LLVM_INCLUDE=${{ matrix.llvm_include }} LLVM_LIB=${{ matrix.llvm_lib }} uv run tools/build_server.sh

      - name: Verify binary
        run: |
          file mojokernel/bin/mojo-repl-server
          if [ "$(uname)" = "Darwin" ]; then
            otool -L mojokernel/bin/mojo-repl-server
          else
            ldd mojokernel/bin/mojo-repl-server
          fi

      - name: Build wheel
        run: uv build --wheel -o dist/

      - name: Fix Linux wheel platform tag
        if: runner.os == 'Linux'
        run: |
          uv run pip install auditwheel patchelf
          uv run auditwheel show dist/*.whl
          LLDB_SO=$(patchelf --print-needed mojokernel/bin/mojo-repl-server | grep liblldb)
          echo "Excluding: $LLDB_SO"
          uv run auditwheel repair dist/*.whl -w dist-fixed/ --exclude "$LLDB_SO"
          rm dist/*.whl
          mv dist-fixed/*.whl dist/

      - name: Verify wheel
        run: |
          ls -lh dist/*.whl
          uv run python3 -c "
          import zipfile
          whl = sorted(__import__('glob').glob('dist/*.whl'))[0]
          print('Wheel:', whl)
          with zipfile.ZipFile(whl) as z:
              for f in z.namelist():
                  info = z.getinfo(f)
                  if info.file_size > 1000 or 'bin/' in f:
                      print(f'  {f}  ({info.file_size:,} bytes)')
          "

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}
          path: dist/*.whl

  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
      - name: Detect Mojo version
        run: |
          MOJO_VERSION=$(gh api repos/modular/mojo/releases/latest --jq .tag_name | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "MOJO_VERSION=$MOJO_VERSION" >> $GITHUB_ENV
          echo "Mojo version: $MOJO_VERSION"
        env:
          GH_TOKEN: ${{ github.token }}
      - run: uv build --sdist -o dist/
      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  publish:
    if: inputs.publish
    needs: [build, build-sdist]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true
      - run: ls -lh dist/
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
