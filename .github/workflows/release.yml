name: Build and publish wheels

on:
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to PyPI'
        type: boolean
        default: false

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-14
            llvm_install: brew install llvm
            llvm_include: /opt/homebrew/opt/llvm/include
            llvm_lib: /opt/homebrew/opt/llvm/lib
          - os: ubuntu-latest
            llvm_install: sudo apt-get update && sudo apt-get install -y llvm-18-dev liblldb-18-dev
            llvm_include: /usr/lib/llvm-18/include
            llvm_lib: /usr/lib/llvm-18/lib
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7

      - name: Install Mojo
        run: |
          uv pip install --system modular --extra-index-url https://modular.gateway.scarf.sh/simple/
          mojo --version

      - name: Install dependencies
        run: uv pip install --system ".[dev]"

      - name: Install LLVM
        run: |
          ${{ matrix.llvm_install }}
          echo "--- Verify headers ---"
          ls ${{ matrix.llvm_include }}/lldb/Target/Target.h
          ls ${{ matrix.llvm_include }}/lldb/API/SBDebugger.h

      - name: Build server
        run: LLVM_INCLUDE=${{ matrix.llvm_include }} LLVM_LIB=${{ matrix.llvm_lib }} tools/build_server.sh

      - name: Verify binary
        run: |
          file mojokernel/bin/mojo-repl-server
          if [ "$(uname)" = "Darwin" ]; then
            otool -L mojokernel/bin/mojo-repl-server
          else
            ldd mojokernel/bin/mojo-repl-server
          fi

      - name: Build wheel
        run: uv build --wheel -o dist/

      - name: Verify wheel
        run: |
          ls -lh dist/*.whl
          python3 -c "
          import zipfile
          whl = sorted(__import__('glob').glob('dist/*.whl'))[0]
          print('Wheel:', whl)
          with zipfile.ZipFile(whl) as z:
              for f in z.namelist():
                  info = z.getinfo(f)
                  if info.file_size > 1000 or 'bin/' in f:
                      print(f'  {f}  ({info.file_size:,} bytes)')
          "

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}
          path: dist/*.whl

  build-sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
      - run: uv build --sdist -o dist/
      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  publish:
    if: inputs.publish
    needs: [build, build-sdist]
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true
      - run: ls -lh dist/
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
